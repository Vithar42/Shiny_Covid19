---
title: "Predictive Modeling"
author: "Nick Johnson"
date: "4/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(growthcurver)
library(tidyverse)
library(easynls)
library(growthmodels)


```

```{r global, include=FALSE}
# things that will be globaly available when Shiny is running...
source("global.R")
state_choice <- "Michigan"

input <- list(states = c("Minnesota", "Michigan", "Wisconsin","North Dakota", "Ohio", "South Dakota", "Iowa"),
             deathrate = 0.8,
             dayo = 1,
             dayodeath = 5,
             logscaletoggle = "Log")

```

## Growth Plot of `r state_choice`

### Formula used in the growthcurver package
$y = \frac{k}{1+\frac{(k-n_0)}{n_o}} * e^\left(-r * t \right)$

### Gompertz curve
$N(t)=N_0 * e^\left(\ln\left(\frac{N_I}{N_0}\right)\right)(1-e^\left(-bt\right)))$


```{r cars}

df <- alldata %>%
    filter(state %in% input$states) %>%
    left_join(statePop, by = "state") %>%
    mutate(pop = pop/100000) %>%
    mutate(positivepop =  positive/pop,
           deathpop =  death/pop,
           hospitalizedpop = hospitalized/pop)
  
df <- df %>%
  filter(state == state_choice) %>%
  group_by(state) %>%
  mutate(dayNo = if_else(positive >= input$dayo, 1, 0, missing = NULL)) %>%
  mutate(dayNo = cumsum(dayNo) - 1) %>%
  filter(dayNo >= 0) %>%
  ungroup(state) %>%
  select(dayNo, positive)
  
t <- 1:(length(df$dayNo)*3)
a <- max(df$positive)/2
b <- min(df$positive)
c <- 0.05


# 9 = "y~a*(1-b*(exp(-c*x)))" brody
model9 = nlsfit(df, model = 9, start=c(15000, 9, 0.5))
predict9 <- model10[2]$Parameters$positive[1] * (1 - model10[2]$Parameters$positive[2] * (exp(-model10[2]$Parameters$positive[3] * t)))

# 10 = "y~a*exp(-b*exp(-c*x)" gompertz
model10 = nlsfit(df, model = 10, start=c(a, b, c))
predict10 <- model10[2]$Parameters$positive[1] * exp(-model10[2]$Parameters$positive[2] * exp(-model10[2]$Parameters$positive[3] * t))
df_predict10 <- data.frame(dayNo = t, pred = predict10)

p <- ggplot(df, aes(x = dayNo, y = positive)) + 
  geom_point(alpha=0.7) +
  geom_line(data = df_predict9, aes(x = dayNo, y = pred), color = "red") +
  geom_line(data = df_predict10, aes(x = dayNo, y = pred), color = "blue")

ggplotly(p)
    
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
